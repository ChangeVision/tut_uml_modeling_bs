ifndef::revnumber[]
include::front_matter.adoc[]
endif::[]

[[_behavior_design]]
== スコアやフレームの状態を調べる

[.lead]
設計で作成するモデルと実装に使うプログラムの対応づけができたので、この対応づけを前提に、ボウリングスコアのモデルの作成を進めましょう。

=== フレームの状態について検討する

<<scoresheet01>> を見ると、ゲームの進行状況によってフレームが提示する情報には <<frama_differences>> のような違いがあります。

[[frama_differences]]
.フレームの提示する情報の違い
[example]
--
* まだプレーしていないフレーム
* 1投目の投球を待っているフレーム
* 2投目の投球を待っているフレーム
* 2投目が投球されて獲得ピン数が確定したフレーム
* ストライクのボーナスが確定しないフレーム
* スペアのボーナスが確定しないフレーム
* スペアまたはストライクのボーナスが確定したフレーム
--

==== まだプレーしていないフレーム

まだプレーしてないフレームは、フレームの最初の状態です（ <<reserved01>> ）。
このフレームは、ピン数の入力を待っていません。

[[reserved01]]
.まだプレーしていないフレーム
image::reserved.png[{three-quarters-width}]

==== 1投目の投球を待っているフレーム

現在プレー中のフレームで、まだ1投目が投球されていない状態のフレームです（ <<before_1st01>> ）。
次にピン数を受け取ると、このフレームの1投目に記録されます。

[[before_1st01]]
.1投目の投球を待っているフレーム
image::before_1st.png[{three-quarters-width}]

==== 2投目の投球を待っているフレーム

現在プレー中のフレームで、1投目がストライクでなかったときに2投目を待っている状態のフレームです（ <<before_2nd01>> ）。
次にピン数を受け取ると、このフレームの2投目に記録されます。

[[before_2nd01]]
.2投目の投球を待っているフレーム
image::before_2nd.png[{three-quarters-width}]


==== スペアのボーナスの確定待ちのフレーム

現在プレー中のフレームの前のフレームがスペアで、現在のフレームが1投目の投球を待っているとき、前のフレームはスペアボーナスの確定待ちの状態です（ <<pending_spare01>> ）。
次にピン数を受け取ると、このフレームの1投目に記録されるとともに、前のフレームのスペアボーナスが確定します。

[[pending_spare01]]
.スペアのボーナスの確定待ちのフレーム
image::pending_spare.png[{three-quarters-width}]

==== ストライクのボーナスの確定待ちのフレーム

ストライクボーナスの確定待ちには2通りの場合があります。

まず、現在プレー中のフレームの前のフレームがストライクで、現在のフレームが2投目の投球を待っているときです。
このとき、前のフレームはストライクボーナスの確定待ちの状態です（ <<pending_strike01>> ）。
次にピン数を受け取ると、このフレームの2投目に記録されるとともに、前のフレームのストライクボーナスが確定します。

[[pending_strike01]]
.ストライクのボーナスの確定待ちのフレーム（次がストライクでない）
image::pending_strike.png[{three-quarters-width}]

いまひとつは、現在プレー中のフレームが1投目の投球を待っていて、前のフレームと前の前のフレームがともにストライクであったとき（ダブルのとき）ときです。
このとき、前の前のフレームはストライクボーナスの確定待ちの状態です（ <<pending_double01>> ）。
次にピン数を受け取ると、このフレームの1投目に記録されるとともに、前の前のフレームのストライクボーナスが確定します。

[[pending_double01]]
.ストライクのボーナスの確定待ちのフレーム（次がストライク）
image::pending_double.png[{three-quarters-width}]


==== 獲得ピン数とボーナスが確定したフレーム

現在のフレームがスペアやストライクにならなかったとき、そのフレームはボーナスの確定待ちにならず、この段階でそのフレームのトータル（ボーナスなしの獲得ピン数）が確定します。

スペアボーナスの確定待ち、またはストライクボーナスの確定待ちのフレームは、後のフレームの投球によってボーナスが確定すると、フレームのトータルが確定します。
このとき、確定待ちのフレームでは、そのフレームの獲得ピン数と確定したボーナスの合計がそのフレームのトータルになります。

フレームのトータルが求められると、それ以前のフレームまでの「延べのトータル」にそのフレームのトータルを加算して、延べのトータルを更新します。そして、更新した延べのトータルがフレームの下部に記録されます（ <<fixed01>> ）。

[[fixed01]]
.2投目を投球して、ピン数が確定したフレーム（のべのトータルが求められている）
image::fixed01.png[{three-quarters-width}]


=== フレームの状態をステートマシン図で表す

フレームの状態を検討した結果、フレームはいくつかの状態を持つことがわかりました。
フレームが表示できる情報も、状態によって異なることがわかりました。
このことを、図に表してみましょう。
状態とその変化（状態遷移と呼びます）を表すには、ステートマシン図を使います。

==== フレームクラスにステートマシン図を追加する

「Frame」クラスの状態を表す図を描きたいので、「Frame」クラスに図を追加しましょう。

[[add_frame_stm00]]
.フレームクラスにステートマシン図を追加する
[example]
--
. 「Frame」クラスにステートマシン図を追加する
** 構造ツリーから「Frame」クラスを選択し、右クリックしてポップアップメニューを表示する（ <<add_frame_stm01>> ）。
** 「図の追加＞ステートマシン図」でステートマシン図が追加される。

[[add_frame_stm01]]
.フレームクラスにステートマシン図を追加する
image::GSW-20220207-154421.png[{three-quarters-width}]

[start=2]
. ステートマシン図に名前をつける
** 追加したステートマシン図のプロパティの「ベース」を開く。
** 名前を編集して「Frameクラスのステートマシン図」とする（ <<add_frame_stm02>> ）。
** ダイアグラムエディタのタイトルやタブにも反映される。
--

==== ステートマシン図に状態を追加する

ステートマシン図に、フレームの状態を追加しましょう。

[[add_frame_state00]]
.ステートマシン図にフレームの状態を追加する
[example]
--
. パレットから「開始疑似状態」を選択し、ステートマシン図に追加する。
. パレットから「状態」を選択し、ステートマシン図に追加する。
. 「まだプレーしていないフレーム」を「RESERVED」という名前にする。
. パレットから「遷移」を選択して、「開始疑似状態」から「RESERVED」へ遷移を引く（ <<frame_state01>> ）。


[[frame_state01]]
.状態の追加（１）
image::GSW-20220209-152917.png[{full-width}]

[start=5]
. 「1投目の投球を待っているフレーム」を「BEFORE_1ST」という名前にする。
. 「BEFORE_1ST」という状態名の状態を追加する。


[[frame_stm02]]
.状態の追加（２）
image::GSW-20220207-155242.png[{full-width}]


. 「2投目の投球を待っているフレーム」を「BEFORE_2ND」
. 「スペアのボーナスの確定待ちのフレーム」と「ストライクのボーナスの確定待ちのフレーム」を「PENDING」
. 「獲得ピン数とボーナスが確定したフレーム」を表す「FIXED」

--

=== サービスフレームの扱いについて検討する

「クラッシックスコアリング」の場合、第10フレームが他のフレームとは異なっています。
サービスフレームという考え方があり、ストライクやスペアの場合に追加で投球できます。

このサービスフレームの扱い方にについて整理しておきましょう。

==== 第10フレームがストライクもスペアもない場合

第10フレームがストライクでもスペアもない場合、サービスフレームは提供されません。
第9フレームまでの通常のフレームと同様、1投目と2投目を記録するだけです（ <<ten_no_service>>  ）。


[[ten_no_service]]
.第10フレームがストライクもスペアもない場合
image::ten_no_service_combo.png[{three-quarters-width}]

==== 第10フレームがスペアの場合

第10フレームの2投目でスペアになった場合、1投目と2投目を通常のフレームと同様に記録したのち、もう1投追加されます。
これを、第10フレームに加えて、第11フレームの1投目が追加されたとみなします。
つまり、ゲームスコアのデータを「 <<ten_spare_service>> 」のように構成します。

[[ten_spare_service]]
.第10フレームがスペアの場合（第11フレームの2投目はない）
image::ten_spare_combo.png[{three-quarters-width}]

スコアをこのように構成しておくと、第10フレームの場合も、通常フレームの組み合わせによってボーナスが計算できます。
ゲーム終了時の第10フレームのスコア（ピン数に以後の投球によるボーナスを加えたスコア）を取得するとそれがゲームのスコアになります。


==== 第10フレームの1投目がストライクの場合

第10フレームの1投目がストライクの場合、第10フレームをストライクとした上で、もう2投追加されます。
これを、第10フレームに加えて、第11フレームの1投目と2投目が追加されたとみなします。
つまり、ゲームスコアのデータを「 <<ten_one_strike_service>> 」のように構成します。
だたし、第11フレームの1投目がストライクの場合は、同じ2投追加でも次の「2投目もストライクの場合」の考え方を使います。

[[ten_one_strike_service]]
.第10フレームの1投目がストライクの場合
image::ten_one_strike_combo.png[{three-quarters-width}]

スコアをこのように構成しておくと、第10フレームの場合も、通常フレームの組み合わせによってボーナスが計算できます。
ゲーム終了時の10フレームのスコア（ピン数に以後の投球によるボーナスを加えたスコア）を取得するとそれがゲームのスコアになります。

==== 第10フレームの2投目もストライクの場合

第10フレームの2投目もストライクの場合、第10フレーム、第11フレームをストライクとした上で、もう1投追加されます。
これを、第10フレーム、第11フレームに加えて、第12フレーム目の1投目が追加されたとみなします。
つまり、ゲームスコアのデータを「 <<ten_two_strike_service>> 」のように構成します。
このように構成すれば、通常のフレームでダブルをとったときの計算方法（ストライクが続いたときはさらに次のフレームの1投目が2投目として加算される）のままで第10フレームのボーナスが計算できます。

[[ten_two_strike_service]]
.第10フレームの2投目もストライクの場合
image::ten_two_strike_combo.png[{three-quarters-width}]

スコアをこのように構成しておくと、第10フレームの場合も、通常フレームの組み合わせによってボーナスが計算できます。
ゲーム終了時の10フレームのスコア（ピン数に以後の投球によるボーナスを加えたスコア）を取得するとそれがゲームのスコアになります。


==== クラス図に検討結果を反映する

第10フレームの場合にもサービスフレームのために追加のフレームを用意することで、通常フレームと同じようにピン数やボーナスを扱えるようになりました。

クラス図にこの結果を反映しましょう。


[[add_service_frame]]
.クラス図にサービスフレームを検討結果を反映する
[example]
--
. 「Frame」クラス側の関連端の多重度を「10」から「12」に変更する。
. 関連にノートをつけて説明をつけておく。
** パレットからノートを選択し、クラス図に追加する。
** ノートに「Frame側の多重度は、サービスフレーム用に必要なフレーム分だけ追加してある」という説明を追加する。
. ノートから関連の線に向かってアンカーを引く。
** パレットからノートのアンカーを選択し、ノートにマウスカーソルを移動して青枠が表示されるのを待つ。
** マウスのボタンを押したまま、マウスカーソルをドラッグし、関連の線に近づけ青枠が表示されるのを待つ。


TIP: ノート内の文章を編集するときは、ノートを選択した状態でプロパティを使って編集すると、改行の入力が容易になります。

--


=== ゲームの進行について検討する



