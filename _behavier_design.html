<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="description" content="この文書は、モデリングツールにastah*を使って、ソフトウェアの開発にUMLを使う方法について学ぶチュートリアルです。">
<meta name="author" content="株式会社チェンジビジョン">
<title>モデルを使って ソフトウェアを開発しよう: astah* を使った UMLチュートリアル</title>
<link rel="stylesheet" href="css/mystyle.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="_behavier_design" class="book toc2 toc-left">
<div id="header">
<h1>モデルを使って ソフトウェアを開発しよう: astah* を使った UMLチュートリアル</h1>
<div class="details">
<span id="author" class="author">株式会社チェンジビジョン</span><br>
<span id="revnumber">バージョン html_0120,</span>
<span id="revdate">2022-01-17</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目次</div>
<p><span class="toc-root"><a href="uml_tutorial.html">モデルを使って ソフトウェアを開発しよう: astah* を使った UMLチュートリアル</a></span></p><ul class="sectlevel1">
<li><a href="_preface.html">はじめに</a>
</li>
<li><a href="_copyright.html">注意事項</a>
</li>
<li><a href="_preparation.html">1 準備</a>
</li>
<li><a href="_requirement_anaylysis.html">2 解決したい課題はなにか</a>
</li>
<li><a href="_structure_design.html">3 スコアの構造を図にする</a>
</li>
<li><a href="_behavier_design.html"><span class="toc-current">4 スコア記録の振る舞いを図にする</span></a>
<ul class="sectlevel2">
<li><a href="_behavier_design.html#_振る舞いの図を選択する">4.1 振る舞いの図を選択する</a>
</li>
<li><a href="_behavier_design.html#_ステートマシン図を描く">4.2 ステートマシン図を描く</a>
</li>
</ul>
</li>
<li><a href="_summary.html">5 まとめ</a>
</li>
<li><a href="_other_diagrams.html">6 他の図、他の機能など</a>
</li>
<li><a href="_appendix-01.html">付録 A: 関連資料、ワークシート等</a>
</li>
<li><a href="_glossary.html">用語集</a>
</li>
<li><a href="_bibliography.html">参考文献</a>
</li>
<li><a href="_colophon.html">奥付</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_behavier_design"><a class="anchor" href="#_behavier_design"></a>4 スコア記録の振る舞いを図にする</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>スコアの構造を検討できたので、こんどは、ゲームを進めるときの動作をモデル図を使って整理してみましょう。</p>
</div>
<div class="sect2">
<h3 id="_振る舞いの図を選択する"><a class="anchor" href="#_振る舞いの図を選択する"></a>4.1 振る舞いの図を選択する</h3>
<div class="paragraph">
<p>振る舞いを表す図には「 <a href="_behavier_design.html#behaiver_diagrams">表 4.1</a> 」に挙げたようなものがあります。</p>
</div>
<table id="behaiver_diagrams" class="tableblock frame-all grid-all stretch">
<caption class="title">表 4.1 よく使う振舞いのモデル図</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">図の種類</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">シーケンス図</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">クラスやオブジェクトの間のやり取りを整理するのに向いています。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">アクティビティ図</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">処理の流れや条件による処理の分岐を表すのに向いています。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ステートマシン図</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">起きるのを待っているできごと（イベント）と、イベントが起きた時の処理（アクション）を使って振る舞いを表すのに向いています。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>では、ゲームを進めるときの動作を考えるとき、どの図を使うのがよいでしょうか。
たとえば、「Game」クラスと「GameScore」クラスは「 <a href="_behavier_design.html#game_gamesocre_interaction">GameクラスとGameScoreクラスの間のやり取り</a> 」に示すような手順となります。</p>
</div>
<div id="game_gamesocre_interaction" class="olist arabic">
<div class="title">GameクラスとGameScoreクラスの間のやり取り</div>
<ol class="arabic">
<li>
<p>システムの利用者は「Game」クラスの操作「play」を呼び出す。</p>
</li>
<li>
<p>実際のゲームが進行する間、「Game」クラスは次のことを繰り返す。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>「Game」クラスは、ゲームで投球がある都度、ピン数の入力を受け付ける。</p>
</li>
<li>
<p>「Game」クラスは、「GameScore」クラスの操作「scoring」を呼び出して、入力されたピン数を渡す。</p>
</li>
<li>
<p>「GameScore」クラスは、操作「scoring」を実行してスコアを記録する。</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>このやり取りを図で表したいなら、シーケンス図が向いているでしょう。
ですが、この程度であるなら、必ずしも図を描いて処理の内容を検討するほどではないでしょう。</p>
</div>
<div class="paragraph">
<p>一方で、「GameScore」クラスの操作「scoring」の動作では、ゲームが進むたびにフレームのインスタンスの追加やボーナスの計算が必要です。
また、ボーナスを計算するには、いまどのような状況か（何フレーム目の何投目か）を判断する必要もあります。
ということは、操作「scoring」の動作では、ゲームの状況を判断するために「状態を維持する」必要がありそうです。
そして、ピン数を受け取ったときにスコアを計算するというのは、「できごとが起きたときに何かをする」という考え方で動作を整理する必要があることを意味しています。
この考え方に従って振る舞いを検討するには「ステートマシン図」を使うのがよさそうです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_ステートマシン図を描く"><a class="anchor" href="#_ステートマシン図を描く"></a>4.2 ステートマシン図を描く</h3>
<div class="paragraph">
<p>では、「GameScore」クラスの操作「scoring」の動作を検討するために、ステートマシン図を作成しましょう。</p>
</div>
<div class="paragraph">
<p>振る舞いの捉え方によって、振る舞いの図がどのようなものになるのかはかわります。
この演習では「ピンの入力を待っていてピン数が入力されたらスコアを計算する」という考え方に従って振る舞いを考えてみましょう。</p>
</div>
<div class="sect3">
<h4 id="_設計モデルにステートマシン図を追加する"><a class="anchor" href="#_設計モデルにステートマシン図を追加する"></a>4.2.1 設計モデルにステートマシン図を追加する</h4>
<div class="paragraph">
<p>まず、「ゲームスコアのステートマシン図」を追加しましょう。
追加したいのは「GameScore」クラスの振舞いを表すステートマシン図なので、それがわかるよう「GameScore」クラスに対して追加しましょう。</p>
</div>
<div class="openblock">
<div class="title">ゲームスコアのステートマシン図を追加する</div>
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>「GameScore」クラスにステートマシン図を追加する（ <a href="_behavier_design.html#stm00">図 4.1</a> ）。</p>
</li>
</ol>
</div>
<div id="stm00" class="imageblock">
<div class="content">
<img src="images/stm00.png" alt="stm00" width="50%">
</div>
<div class="title">図 4.1 「GameScore」クラスにステートマシン図を追加する</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>追加した図を「GmaeScoreのscoringのステートマシン図」とする（ <a href="_behavier_design.html#stm01">図 4.2</a> ）。</p>
</li>
</ol>
</div>
<div id="stm01" class="imageblock">
<div class="content">
<img src="images/stm01.png" alt="stm01" width="75%">
</div>
<div class="title">図 4.2 追加した図を「GameScoreのscoringのステートマシン図」とした</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_状態と状態遷移を追加する"><a class="anchor" href="#_状態と状態遷移を追加する"></a>4.2.2 状態と状態遷移を追加する</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="重要"></i>
</td>
<td class="content">
<div class="title">状態名は後まわしにする</div>
<div class="paragraph">
<p>状態を配置すると、状態名をつけたくなります。ですが、状態名をつけるのは後まわしにしましょう。
なぜなら、どのような状態なのかを決定する要因は、状態名ではなく、イベントやアクションだからです。
そして、イベントやアクションが定まったら、イベントやアクション（あるいはそれらの元となる仕様上の処理の名前など）を元に状態名を命名します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ステートマシン図を使って振る舞いを考える時、最初に考えるのは「何が起きるのを待っているのか」です。
ユースケース記述「 <a href="_requirement_anaylysis.html#use_case_desc08">リスト3</a> を読むと、ゲームを始めた段階では、「1投目のピン数を受け取るのを待っている」と考えればよさそうです。</p>
</div>
<div class="paragraph">
<p>まず、ステートマシン図に状態と状態遷移を追加しましょう。</p>
</div>
<div class="olist arabic">
<div class="title">イベント「ピン数を受け取った」を追加する</div>
<ol class="arabic">
<li>
<p>ステートマシン図に状態を2つ追加する。</p>
<div class="ulist">
<ul>
<li>
<p>パレットから「状態」のシンボルを選択して、図に配置する（ <a href="_behavier_design.html#stm02">図 4.3</a> ）。</p>
</li>
<li>
<p>一方の状態には、最初の状態だとわかるよう「開始疑似状態」をつける。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm02" class="imageblock">
<div class="content">
<img src="images/stm02.png" alt="stm02" width="50%">
</div>
<div class="title">図 4.3 状態と開始疑似状態を追加した</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>状態遷移を追加する。</p>
<div class="ulist">
<ul>
<li>
<p>パレットから「遷移」のシンボルを選択して、一方の状態にマウスカーソルを移動する。</p>
</li>
<li>
<p>青い枠が現れたら、マウスをクリックし、そのままドラッグする（ <a href="_behavier_design.html#stm03">図 4.4</a> ）。</p>
</li>
<li>
<p>折り曲げたいときは途中でもマウスをクリックする。</p>
</li>
<li>
<p>もう一方の状態の中にマウスを移動して青い枠が現れたらマウスを離すと、「遷移」が引かれる（ <a href="_behavier_design.html#stm04">図 4.5</a> ）。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm03" class="imageblock">
<div class="content">
<img src="images/stm03.png" alt="stm03" width="50%">
</div>
<div class="title">図 4.4 状態と状態の間に遷移を追加する</div>
</div>
<div id="stm04" class="imageblock">
<div class="content">
<img src="images/stm04.png" alt="stm04" width="50%">
</div>
<div class="title">図 4.5 状態と状態の間に遷移を追加した</div>
</div>
</div>
<div class="sect3">
<h4 id="_イベントを追加する"><a class="anchor" href="#_イベントを追加する"></a>4.2.3 イベントを追加する</h4>
<div class="paragraph">
<p>状態遷移が追加できたら、最初の状態で起きるのを待っているできごとを考えて、イベントとして追加しましょう。</p>
</div>
<div class="paragraph">
<p>最初の状態では、投球したピン数を受け取るのを待っていますね。
そして、状態が遷移するときは、既に（いままさに）受け取ったときになります。
そこで、イベントとして表すときには「ピン数を受け取った」のように表します。
「受け取る」とすると、まだ受け取るのを待っているところなのか、もう受け取った後なのかはっきりしません。
あるいは、「渡す（渡した）」としてしまうと「GameScore」クラスがピン数を渡すとみなされてしまいます。
イベント名を考えるときは、動作の主体やイベントが「起きた」といった時制を意識してみてください。</p>
</div>
<div class="olist arabic">
<div class="title">イベント「ピン数を受け取った」を追加する</div>
<ol class="arabic">
<li>
<p>追加した遷移を選択した状態で、プロパティの「トリガー」を編集して「ピン数を受け取った」とする（ <a href="_behavier_design.html#stm05">図 4.6</a> ）。</p>
</li>
<li>
<p>受け取るピン数がわかるよう、ピン数をパラメータとして追加しておいた。</p>
</li>
</ol>
</div>
<div id="stm05" class="imageblock">
<div class="content">
<img src="images/stm05.png" alt="stm05" width="75%">
</div>
<div class="title">図 4.6 イベント「1投目のピン数を受け取った」を追加した</div>
</div>
</div>
<div class="sect3">
<h4 id="_アクションを追加する"><a class="anchor" href="#_アクションを追加する"></a>4.2.4 アクションを追加する</h4>
<div class="paragraph">
<p>次に考えるのは、イベントが起きたときに実行したい処理（アクション）です。
1投目のピン数を受け取るのを待っているときにやりたい処理は、ユースケース記述「 <a href="_requirement_anaylysis.html#use_case_desc08">リスト3</a> 」の「現在の状態が、1投目のピン数入力待ちのとき」に書いてある処理です。
アクションに記載する処理と次の状態への遷移がわかるよう、抜粋した記述に説明を追加しておきました（ <a href="_behavier_design.html#use_case_desc08_sub01">「現在の状態が、1投目のピン数入力待ちのとき」の処理（ユースケース記述より抜粋）</a> ）。</p>
</div>
<div id="use_case_desc08_sub01" class="openblock">
<div class="title">「現在の状態が、1投目のピン数入力待ちのとき」の処理（ユースケース記述より抜粋）</div>
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ゲームスコアに新しいフレームを追加する。（アクションでやりたいこと）</p>
</li>
<li>
<p>現在のフレームの1投目にピン数を記録する。（アクションでやりたいこと）</p>
</li>
<li>
<p>1投目がストライクだったときは、現在の状態を次の1投目のピン数入力待ちに変更する。（次の状態への遷移1）</p>
</li>
<li>
<p>ストライクでなかったときは、現在の状態を2投目のピン数入力待ちに変更する。（次の状態への遷移2）</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>ステートマシン図にアクションを書くときは、このユースケース記述をそのまま書くのではなく、まず「操作に追加してそれをアクションとして呼び出す」方法を原則としましょう。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="注記"></i>
</td>
<td class="content">
<div class="title">アクションを操作にしてから書く理由</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>その処理に名前をつけることです。名前をつけることで、まとまりのある処理と捉えやすくなります。</p>
</li>
<li>
<p>再利用の促進です。操作にしておけば、他の場面でも呼び出して使えます。</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>この演習において、同じ処理が他の状態に現れる場面があるのかはっきりしていませんが、原則に従って作成してみます。</p>
</div>
<div class="paragraph">
<p>操作の名前は、「1投目のピン数入力待ちのとき」のアクションという意味を込めて「first_action」としましょう。</p>
</div>
<div class="olist arabic">
<div class="title">「1投目のピン数入力待ちのとき」のアクションを追加する</div>
<ol class="arabic">
<li>
<p>「Frame」クラスに、操作「first_action」を追加する（ <a href="_behavier_design.html#class20">図 4.7</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>クラス図を開き、 Frame クラスに操作を追加する（操作を追加する手順は省略）。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="class20" class="imageblock">
<div class="content">
<img src="images/class20.png" alt="class20" width="50%">
</div>
<div class="title">図 4.7 Frameクラスに操作「first_action」を追加した</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>追加した操作をアクションに追加する（ <a href="_behavier_design.html#stm06">図 4.8</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>アクションを追加したい状態を選択して、プロパティの「入場/実行/退場」タブを選択する。</p>
</li>
<li>
<p>「入場動作」に「first_action」と入力する。</p>
</li>
<li>
<p>マウスカーソルを図に戻すと、入力が反映される。</p>
</li>
<li>
<p>ノートを追加して、アクション詳細を書いておいた。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm06" class="imageblock">
<div class="content">
<img src="images/stm06.png" alt="stm06" width="100%">
</div>
<div class="title">図 4.8 アクション「first_action」を状態に追加した</div>
</div>
<div class="paragraph">
<p>そして、「 <a href="_behavier_design.html#use_case_desc08_sub01">「現在の状態が、1投目のピン数入力待ちのとき」の処理（ユースケース記述より抜粋）</a> 」の後半部分、次の状態への遷移を追加します。
記述をみると状態遷移は2つあります。
まず、考えやすいストライクでなかったときを考えていましょう。
このときは、2投目のピン数を受け取るのを待つことになりますので、そのための状態遷移とイベントを追加します。</p>
</div>
<div class="olist arabic">
<div class="title">2投目のピン数入力待ちに遷移する状態遷移を追加する（ <a href="_behavier_design.html#stm07">図 4.9</a> ）。</div>
<ol class="arabic">
<li>
<p>新しい状態を追加する。</p>
</li>
<li>
<p>追加した状態へ向かう状態遷移を追加する。</p>
</li>
</ol>
</div>
<div id="stm07" class="imageblock">
<div class="content">
<img src="images/stm07.png" alt="{three-quarters-width">
</div>
<div class="title">図 4.9 2投目のピン数入力待ちに遷移する状態遷移を追加した</div>
</div>
</div>
<div class="sect3">
<h4 id="_ストライクのときの状態遷移を追加する"><a class="anchor" href="#_ストライクのときの状態遷移を追加する"></a>4.2.5 ストライクのときの状態遷移を追加する</h4>
<div class="paragraph">
<p>では、ストライクだったときはどうしたらよいでしょうか。
このときは、「1投目のピン数入力待ちのとき」のアクションを実行した上で、次のフレームの1投目のピン数を受け取るのを待つことになります。
つまり、前の状態に戻るということです。
この状態遷移を追加してみましょう。</p>
</div>
<div class="olist arabic">
<div class="title">ストライクだったときの状態遷移を追加する（ <a href="_behavier_design.html#stm07-2">図 4.10</a> ）。</div>
<ol class="arabic">
<li>
<p>最初の状態への状態遷移を新しい状態を追加する。</p>
</li>
<li>
<p>追加した状態へ向かう状態遷移を追加する。</p>
</li>
</ol>
</div>
<div id="stm07-2" class="imageblock">
<div class="content">
<img src="images/stm07-2.png" alt="{full-width]">
</div>
<div class="title">図 4.10 次の1投目のピン数入力待ちに遷移する状態遷移を追加した（期待通りに動作しない）</div>
</div>
<div class="paragraph">
<p>この状態遷移には、待っているイベントがありません。
イベントが書いていない遷移は、遷移元の状態におけるアクションが実行された後、イベントが発生していなくても状態が遷移するという意味になります。
このような状態遷移を「自動遷移（ラムダ遷移）」といいます。</p>
</div>
<div class="paragraph">
<p>しかし、この自動遷移があると、2投目のピン数を受け取るのを待っているにもかかわらず、すぐこちらの状態遷移で遷移してしまいますね。
これは期待している動作ではありません。
つまり、ストライクのときとそうでないときは、状態処理は同じですが区別する必要がありそうです。
区別するということは、2投目を待つ場合と、ストライクで次のフレームを進む場合は別の状態と考えるわけです。</p>
</div>
<div class="paragraph">
<p>同じイベントを受け取ったときに、条件によって遷移先を変えたい場合は、イベントにガード条件を追加します。
ここでは、「ストライク」の場合と「ストライクでない」場合です。</p>
</div>
<div class="olist arabic">
<div class="title">ストライクかどうかで状態遷移を区別する</div>
<ol class="arabic">
<li>
<p>ストライクのきの状態を追加する（ <a href="_behavier_design.html#stm08">図 4.11</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>新しい状態を追加する。</p>
</li>
<li>
<p>最初の状態から追加した状態へ状態遷移を引く。</p>
</li>
<li>
<p>追加した状態から最初の状態へ状態遷移を引く。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm08" class="imageblock">
<div class="content">
<img src="images/stm08.png" alt="{full-width]">
</div>
<div class="title">図 4.11 ストライクのときのために状態を追加した</div>
</div>
</div>
<div class="sect3">
<h4 id="_イベントとアクションの追加を繰り返す"><a class="anchor" href="#_イベントとアクションの追加を繰り返す"></a>4.2.6 イベントとアクションの追加を繰り返す</h4>
<div class="paragraph">
<p>引き続き、ユースケース記述「 <a href="_requirement_anaylysis.html#use_case_desc08">リスト3</a> 」を参照して、イベントとアクションを追加します。</p>
</div>
<div class="paragraph">
<p>1投目のピン数を受け取った状態では、起きるのを待っているできごとは「2投目のピン数を受け取る」ことです。
イベントとしては「2投目のピン数を受け取った」になります。</p>
</div>
<div class="paragraph">
<p>ふたたび、操作と状態と状態遷移を追加して、このイベントを追加します。
追加する操作は、「roll_second」としましょう。</p>
</div>
<div class="olist arabic">
<div class="title">アクション「2投目のスコアを計算する」を追加する</div>
<ol class="arabic">
<li>
<p>「Frame」クラスに、操作「roll_second」を追加する（ &lt;&lt;class21&#8594;&gt; ）。</p>
</li>
</ol>
</div>
<div id="class21-" class="imageblock">
<div class="content">
<img src="images/class21.png" alt="class21" width="50%">
</div>
<div class="title">図 4.12 Frameクラスに操作「roll_second」を追加した</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>イベントとアクションを追加する（ <a href="_behavier_design.html#stm07">図 4.9</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>状態と状態遷移を追加する。</p>
</li>
<li>
<p>状態遷移に、イベント「2投目のピン数を受け取った」を追加する。</p>
</li>
<li>
<p>状態に、アクション「2投目のスコアを計算する」を追加する。</p>
</li>
<li>
<p>ノートを追加して「Frameクラスの roll_second を使う」と書いておく。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm07---" class="imageblock">
<div class="content">
<img src="images/stm07.png" alt="stm07" width="75%">
</div>
<div class="title">図 4.13 アクション「2投目のスコアを計算する」を追加した</div>
</div>
<div class="paragraph">
<p>そして、もし、ストライクやスペアの処理を勘案しないのであれば、この後は最初の状態に戻ればよいですね。
その場合、ステートマシン図は「 &lt;&lt;stm08-&#8594;&gt; 」のようになるでしょう。</p>
</div>
<div id="stm08--" class="imageblock">
<div class="content">
<img src="images/stm08.png" alt="stm08" width="75%">
</div>
<div class="title">図 4.14 最初の状態に戻る自動遷移を追加した</div>
</div>
<div class="paragraph">
<p>この状態遷移にはイベントがありません。このような状態遷移を「自動遷移（ラムダ遷移）」といいます。
自動遷移の場合、前の状態のアクションが実行された後、イベントが発生していなくても状態が遷移します。</p>
</div>
<div class="paragraph">
<p>これで、毎フレーム必ず2投するのを延々繰り返すように動作するステートマシン図ができました。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ストライクの処理を追加する"><a class="anchor" href="#_ストライクの処理を追加する"></a>4.2.7 ストライクの処理を追加する</h4>
<div class="paragraph">
<p>「1投目のピン数を受け取った」あとの処理の詳細は、ユースケース記述「 <a href="_requirement_anaylysis.html#use_case_desc08">リスト3</a> 」の「1投目のスコアを計算する」に書いてあります。これを「 <a href="_behavier_design.html#act01">1投目のスコアを計算する処理の詳細</a> 」に抜粋しておきます。</p>
</div>
<div id="act01" class="olist arabic">
<div class="title">1投目のスコアを計算する処理の詳細</div>
<ol class="arabic">
<li>
<p>ゲームスコアに新しいフレームを追加する。</p>
</li>
<li>
<p>現在のフレームの1投目にピン数を記録する。</p>
</li>
<li>
<p>1投目がストライクだったときは、現在の状態を次の1投目のピン数入力待ちに変更する。</p>
</li>
<li>
<p>ストライクでなかったときは、現在の状態を2投目のピン数入力待ちに変更する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>「 <a href="_behavier_design.html#stm08">図 4.11</a> 」には、1投目で10ピン倒してストライクになったときの処理が反映できていません。
反映するには、ステートマシン図をどのように修正すればよいでしょうか。</p>
</div>
<div class="paragraph">
<p>まず、1投目のピン数を受け取ったら1投目のスコアを計算するのは変わりありません。
そして、受け取ったピン数が10ピンであったときは、2投目のピン数を受け取るのを待たずに次のフレームへ進みます。
そのために、たとえば「 <a href="_behavier_design.html#stm09">図 4.15</a> 」のような状態遷移を追加してみたらどうでしょうか。</p>
</div>
<div id="stm09" class="imageblock">
<div class="content">
<img src="images/stm09.png" alt="stm09" width="75%">
</div>
<div class="title">図 4.15 ストライクのときの状態遷移の検討（1）（期待通りに動作しない）</div>
</div>
<div class="paragraph">
<p>一見、これでなんとかなりそうに思えます。
ところが、ここに自動遷移を書いてしまうと、1投目のスコアを計算した後は必ずこの自動遷移へ向かいます。
ここでは、2投目のピン数を受け取るのも待たなくてはなりませんが、いつもそれよりも先に自動遷移してしまうでしょう。
つまり、ここに自動遷移を書いてしまうと、2投目のピン数を受け取るイベントが来るのを待たなくなってしまうのです。</p>
</div>
<div class="paragraph">
<p>それでは、ストライクで次のフレームへ進むために、別の状態を追加してみます（ <a href="_behavier_design.html#stm10">図 4.16</a> ）。</p>
</div>
<div id="stm10" class="imageblock">
<div class="content">
<img src="images/stm10.png" alt="stm10" width="75%">
</div>
<div class="title">図 4.16 ストライクのときの状態遷移の検討（2）（あいまいさが生じる）</div>
</div>
<div class="paragraph">
<p>これで、「2投目のピン数を受け取るのを待つ」ところには影響がなくなりました。
自動遷移によって次のフレームの1投目を待つところへ戻るのも問題ないでしょう。
しかし、この図では「1投目のピン数を受け取った」という同じイベントで、2つの遷移先ができてしまっています。
このように、同じイベントを待つ2つの状態遷移があると、どちらへ遷移するのかあいまいになってしまいます。
このままでは、どのように動作するのか決められません。</p>
</div>
<div class="paragraph">
<p>この問題を避けるには、1投目のピン数を受け取ったときに、それがストライクなのか調べて区別すればよいでしょう。
そこで、イベントにはイベントが起きたときに評価する条件を追加できるようになっています。
この条件のことを「ガード条件」と呼びます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="重要"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ガード条件は、イベントを待っているときではなく、イベントが起きたときに評価されることを注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>まず、ストライクか調べて真偽を返す操作を追加しましょう。
追加する操作の名前は「strike?」としましょう。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="ヒント"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Rubyでは、真偽を返す操作（Rubyではメソッドと呼びます）の末尾に「?」をつける習慣があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">ストライクのときの状態と状態遷移を追加する</div>
<ol class="arabic">
<li>
<p>「Frame」クラスに、操作「strike?」を追加する（ <a href="_behavier_design.html#class22">図 4.17</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>「strike?」を選択した状態で、プロパティのベースタブの「返り値」のプルダウンメニューから「boolean」を選択する。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="class22" class="imageblock">
<div class="content">
<img src="images/class22.png" alt="class22" width="100%">
</div>
<div class="title">図 4.17 Frameクラスに操作「strike?」を追加した</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>イベントにガード条件を追加する（ <a href="_behavier_design.html#stm11">図 4.18</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>イベント「1投目のピン数を受け取った」を選択した状態で、プロパティの「ガード」欄に「ストライクではなかった」と書く。</p>
</li>
<li>
<p>マウスカーソルを図に戻すと、図上のイベントにガード条件が追加される。</p>
</li>
<li>
<p>状態遷移にノートを追加して「Frameクラスの strike? を使う」と書いておく。</p>
</li>
<li>
<p>前からあった状態遷移の方イベントは「1投目のピン数を受け取った[ストライクではない]」に変更する。</p>
</li>
<li>
<p>追加した状態のアクションに「1投目のスコアを計算する」を追加する。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm11" class="imageblock">
<div class="content">
<img src="images/stm11.png" alt="stm11" width="100%">
</div>
<div class="title">図 4.18 イベントにガード条件を追加した</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>ストライクのときの状態を状態遷移を追加する（ <a href="_behavier_design.html#stm12">図 4.19</a> ）。</p>
<div class="ulist">
<ul>
<li>
<p>（まだ追加していなかった場合）ストライクのときのための状態と状態遷移を追加する。</p>
</li>
<li>
<p>追加した状態遷移に、イベント「1投目のピン数を受け取った[ストライク]」を追加する。</p>
</li>
<li>
<p>追加した状態のアクションに「1投目のスコアを計算する」を追加する。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="stm12" class="imageblock">
<div class="content">
<img src="images/stm12.png" alt="stm12" width="75%">
</div>
<div class="title">図 4.19 ガード条件を使ってストライクのときの状態と状態遷移を追加した</div>
</div>
<div class="paragraph">
<p>これで、同じイベントが起きても、ガード条件の評価結果が異なれば別の状態へ遷移できるようになりました。</p>
</div>
</div>
<div class="sect3">
<h4 id="_サービスフレームの処理を追加する"><a class="anchor" href="#_サービスフレームの処理を追加する"></a>4.2.8 サービスフレームの処理を追加する</h4>
<div class="paragraph">
<p>最終の第10フレームは、3投目を投球できます（サービスフレームと呼ぶこともあるそうです）。
この処理に対応するにはどうしたらよいでしょうか。</p>
</div>
<div class="paragraph">
<p>まず、最終フレームの3投目のピン数を保持するために、3投できるような Frameクラスを用意しましょう。
これは、 Frame クラスを継承すれば作成できそうです（ <a href="_behavier_design.html#class08_svg">図 4.20</a> ）。</p>
</div>
<div class="paragraph">
<p>そして、最終フレームを追加するのは、通常のフレームと同じように操作 add_frame に任せましょう。
その代わり、現在のフレームが何フレーム目なのかわかるよう、GameScoreクラスに作成しているフレームの数を覚えておく属性「size」を追加します。</p>
</div>
<div id="class08_svg" class="imageblock">
<div class="content">
<img src="images/class08.svg" alt="class08" width="50%">
</div>
<div class="title">図 4.20 「ServiceFrame」クラスを追加し、GameScoreクラスに属性「size」を追加した</div>
</div>
</div>
<div class="sect3">
<h4 id="_スペアの判定を追加する"><a class="anchor" href="#_スペアの判定を追加する"></a>4.2.9 スペアの判定を追加する</h4>
<div class="paragraph">
<p>1投目が10ピンでない場合で、2投目で残りのピンをすべて倒した場合は「スペア」になります。
Frameクラスに、スペアかどうか判定する操作「 spare? 」を追加しておきましょう（ <a href="_behavier_design.html#class09_svg">図 4.21</a> ）。</p>
</div>
<div id="class09_svg" class="imageblock">
<div class="content">
<img src="images/class09.svg" alt="class09" width="50%">
</div>
<div class="title">図 4.21 Frameクラスに操作「spare?」を追加する</div>
</div>
</div>
<div class="sect3">
<h4 id="_状態名をつける"><a class="anchor" href="#_状態名をつける"></a>4.2.10 状態名をつける</h4>
<div class="paragraph">
<p><a href="#stm06_svg">[stm06_svg]</a> について、イベントとアクションが決まったので、これらを元に状態名をつけます。
状態名をつけるときは「 &lt;&lt;state_naming_rules&gt; 」のような原則を使ってつけます。</p>
</div>
<div id="state_naming_rules" class="olist arabic">
<div class="title">状態名をつけるときの原則</div>
<ol class="arabic">
<li>
<p>待っているイベントやそのイベントを期待する状況を使って「〜待ち」とする</p>
</li>
<li>
<p>実行中のアクティビティやそのをアクティビティが関連する状況を使って「〜中」とする</p>
</li>
<li>
<p>最後の状態は「〜待ち」や「〜中」とはつけず、「終了」完了」「到着」などとする</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>状態名は、待っているイベントのうち最も期待しているイベント元に「〜待ち」とつけます。
ところが、イベント名そのものを使うと、複数の状態が同じイベントを待っていると状態名が重複してしまいます。
そこで、仕様やユースケース記述を参照して、そのイベントが起きるときの状況を表わしている名前を探して状態名にします。
たとえば「ピン数受け取り待ち」などとなるでしょう。</p>
</div>
<div class="paragraph">
<p>もし、イベントの発生を待っている間、継続して実行している処理があれば、おそらく「do アクティビティ」の処理として書いてあるでしょう。
この処理を元に「〜中」とつける方法もあります。
この場合も、アクションそのものではなく、仕様やユースケース記述からそのアクションを実行している状況を示している名前を参照してつけます。
たとえば「2投目投球中」などとなるでしょう。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="警告"></i>
</td>
<td class="content">
<div class="paragraph">
<p>状態名に「待機中」を使う場合は、要注意です。
対象業務の業務用語として「待機中」が定義されている場合は、そのときを表す名前として使うこともできるでしょう。
これは、業務の用語であるなら、その「待機」が何を待っているのかについても業務として明らかなことが多いからです。
ですが、それ以外の場合は、再考してみた方がよいでしょう。
たいていの場合、待っているということそのものよりも「待っているイベント（や、そのイベントを期待する業務上の状況）は何か」の方が重要です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>それでは、状態名をつけてみましょう。
1投目については、同じイベントに対する別の状態遷移と状態を追加します（ <a href="_behavier_design.html#stm08_svg">図 4.22</a> ）。</p>
</div>
<div id="stm08_svg" class="imageblock">
<div class="content">
<img src="images/stm08.svg" alt="stm08" width="100%">
</div>
<div class="title">図 4.22 状態名をつけた</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Previous: <a href="_structure_design.html">3</a> | ↑ Up: <a href="uml_tutorial.html">モデルを使って ソフトウェアを開発しよう: astah* を使った UMLチュートリアル</a> | Next: <a href="_summary.html">5</a> →</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
バージョン html_0120<br>
最終更新 2022-01-17 06:53:14 +0900
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>